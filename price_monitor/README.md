# üõ°Ô∏è Price Monitor Module

## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å `price_monitor` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –æ—Ä–∞–∫—É–ª–æ–≤ —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. Multi-Oracle Validation
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –≤–Ω–µ—à–Ω–µ–≥–æ –æ—Ä–∞–∫—É–ª–∞ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —Ü–µ–Ω–∞–º–∏ –ø—É–ª–æ–≤
- –í—ã—è–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏
- –ü–æ—Ä–æ–≥–∏: Warning (25%), Critical (50%), Emergency (75%)

### 2. Statistical Anomaly Detection
- –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ü–µ–Ω (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50-70 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
- Z-Score –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä—ã–Ω–∫–∞

### 3. Circuit Breaker System
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
- –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã: Warning, Critical, Emergency
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —É–≥—Ä–æ–∑—ã (1-30 —Å–µ–∫—É–Ω–¥)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `vector<PricePoint>` –≤–º–µ—Å—Ç–æ `Table<u64, PricePoint>`, —Ç–∞–∫ –∫–∞–∫:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ–±–æ–ª—å—à–æ–µ (50-70)
- –í–µ–∫—Ç–æ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö
- –ú–µ–Ω—å—à–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –≥–∞–∑

```move
// –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–Ω–∏—Ç–æ—Ä —Ü–µ–Ω
struct PriceMonitor has store, key {
    config: PriceMonitorConfig,           // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    price_history: vector<PricePoint>,    // –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω (–≤–µ–∫—Ç–æ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
    max_history_size: u64,                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    anomaly_count: u64,                   // –°—á–µ—Ç—á–∏–∫ –∞–Ω–æ–º–∞–ª–∏–π
    is_emergency_paused: bool,            // –°—Ç–∞—Ç—É—Å –ø–∞—É–∑—ã
    pause_timestamp_ms: u64,              // –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–∞—É–∑—ã
    pause_reason: vector<u8>,             // –ü—Ä–∏—á–∏–Ω–∞ –ø–∞—É–∑—ã
    pause_level: u8,                      // –£—Ä–æ–≤–µ–Ω—å –ø–∞—É–∑—ã
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
struct PriceMonitorConfig has store, drop {
    warning_deviation_bps: u64,           // –ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (25%)
    critical_deviation_bps: u64,          // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ (50%)
    emergency_deviation_bps: u64,         // –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ (75%)
    warning_zscore_threshold: u64,        // Z-Score –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (2.5)
    critical_zscore_threshold: u64,       // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π Z-Score (3.0)
    emergency_zscore_threshold: u64,      // –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π Z-Score (4.0)
}

// –¢–æ—á–∫–∞ —Ü–µ–Ω—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
struct PricePoint has store, drop {
    oracle_price_q64: u128,               // –¶–µ–Ω–∞ –æ—Ä–∞–∫—É–ª–∞
    pool_price_q64: u128,                 // –¶–µ–Ω–∞ –ø—É–ª–∞
    deviation_bps: u64,                   // –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –±–∞–∑–∏—Å–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö
    z_score: u64,                         // Z-Score –∞–Ω–æ–º–∞–ª–∏–∏
    timestamp_ms: u64,                    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
    anomaly_level: u8,                    // –£—Ä–æ–≤–µ–Ω—å –∞–Ω–æ–º–∞–ª–∏–∏
    anomaly_flags: u8,                    // –§–ª–∞–≥–∏ —Ç–∏–ø–æ–≤ –∞–Ω–æ–º–∞–ª–∏–π
}
```

### Capabilities

```move
// Capability –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–æ–º
struct PriceMonitorCap has store, key {
    id: UID,
    monitor_id: ID,
}

// Capability –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
struct EmergencyCap has store, key {
    id: UID,
    monitor_id: ID,
}
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∞

```move
let (monitor, monitor_cap, emergency_cap) = price_monitor::create_price_monitor(ctx);
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω

```move
let validation_result = price_monitor::validate_price(
    &mut monitor,
    oracle_price_q64,
    pool_price_q64,
    clock
);

if (!validation_result.is_valid) {
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ä—ã
    // validation_result.anomaly_level —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã
    // validation_result.recommendation —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
};
```



### –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```move
// –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞
price_monitor::emergency_pause(
    &mut monitor, 
    &emergency_cap, 
    b"ORACLE_COMPROMISED", 
    clock
);

// –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
price_monitor::emergency_resume(&mut monitor, &emergency_cap, clock);
```

## –°–æ–±—ã—Ç–∏—è

–ú–æ–¥—É–ª—å —ç–º–∏—Ç–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è off-chain –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- `EventPriceAnomalyDetected` - –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–Ω–æ–º–∞–ª–∏—è —Ü–µ–Ω—ã
- `EventCircuitBreakerActivated` - –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω circuit breaker
- `EventCircuitBreakerDeactivated` - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω circuit breaker
- `EventPriceValidated` - —Ü–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞
- `EventPriceHistoryUpdated` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–æ—Ä–æ–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

- **Deviation (—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –æ—Ä–∞–∫—É–ª-–ø—É–ª)**:
  - Warning: 25% (2500 –±–∞–∑–∏—Å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤)
  - Critical: 50% (5000 –±–∞–∑–∏—Å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤)
  - Emergency: 75% (7500 –±–∞–∑–∏—Å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤)

- **Z-Score (—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏)**:
  - Warning: 2.5 (250)
  - Critical: 3.0 (300)
  - Emergency: 4.0 (400)

- **Circuit Breaker**:
  - Warning: 1 –∞–Ω–æ–º–∞–ª–∏—è
  - Critical: 2 –∞–Ω–æ–º–∞–ª–∏–∏
  - Emergency: 3 –∞–Ω–æ–º–∞–ª–∏–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤

```move
let new_config = PriceMonitorConfig {
    warning_deviation_bps: 2000,      // 20%
    critical_deviation_bps: 4000,     // 40%
    emergency_deviation_bps: 6000,    // 60%
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
};

price_monitor::update_config(&mut monitor, &monitor_cap, new_config);
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏

### –í gauge.move

```move
// –í –º–µ—Ç–æ–¥–µ sync_o_sail_distribution_price
let validation_result = price_monitor::validate_price(
    &mut price_monitor,
    oracle_price_q64,
    pool_price_q64,
    clock
);

if (!validation_result.is_valid) {
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ä—ã
    return;
};

// –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É
gauge.sync_o_sail_distribution_price_internal(pool, oracle_price_q64, clock);
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Capabilities**: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- **–ò–∑–æ–ª—è—Ü–∏—è**: –∫–∞–∂–¥—ã–π –º–æ–Ω–∏—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- **–ê—É–¥–∏—Ç**: –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
sui move test

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ devnet
sui move build --skip-dependency-verification
sui client publish --gas-budget 10000000
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

¬© 2025 Metabyte Labs, Inc. All Rights Reserved.
